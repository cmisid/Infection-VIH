---
title: "Analyse de survie"
author: "Axel Bellec"
date: "2/2/2017"
output: 
  html_document: 
    highlight: pygments
    number_sections: yes
    theme: flatly
---

**TODO**
- Faire le tableau mais à des dates particulières par exemple tous les 6 mois, ou sinon en fonction des probas (pas de 0.1 en 0.1 par exemple).
  + calculer le complémentaire de `survival`

Tableau de résultat: Passer à la semaine ou au mois  

- Construire la courbe de survie.
  + intervalles de confiances pour le global

Taux d'évênement au cours du temps  
Bivarié: test du log-rank  
Multivarié: modèle de Cox

# Modélisation longitudinale par des méthodes d'analyse de survie

```{r, echo=FALSE}
setwd(dir = "~/Google Drive/UPS/M2 SID - 2016_2017/BE_VIH_STATISTIQUE_SANTE/") # Axel
# setwd(dir = "/Users/ismailaddou/Documents/R/Infection-VIH") #Ismail
```

## Définition de la variable arrêt/censure et du délai correspondant

Notre objectif est ici d'étudier la survenue d'évènements au cours du temps. Cela implique d'estimer la probabilité de survenue d'un évènement au cours du temps et également évaluer l'impact d'un facteur sur la survenue de cet évènement.

Afin de mettre en place une modélisation longitudinale par des méthodes d'analyse de survie, nous construisons notre jeu de données.

```{r}
load(file = "base_vih_df_cleaned.Rdata")

library(dplyr)
library(mosaic)

df <- base_vih_df %>%
  mutate(
    duree=ifelse(
      arret_trt == TRUE, 
      as.numeric(d_arret-d_debtrt), 
      as.numeric(d_point-d_debtrt))
    ) %>%
  mutate(arret_trt=as.numeric(arret_trt)) %>%
  select(duree, arret_trt, typetrt) %>%
  arrange(duree)
```

On charge notre jeu de données nettoyé des valeurs manquantes. Puis nous calculons le nombre de jours entre la date de point ($\Rightarrow$ date à laquelle l'étude se termine : fin du recueil des informations) et la date de début du traitement. Enfin, nous effectuons sur ce dataset un tri croissant selon le delta de jours.

```{r}
# Load survival libraries
library(survival)
library(splines)
```

## Méthode de Kaplan-Meier

### Estimations

Nous estimons la survie selon la méthode de Kaplan-Meier. 

```{r}
fits <- survfit(Surv(df$duree, df$arret_trt)~1)
fits
```

```{r}
summary(fits)
```

### Représentation de la courbe de survie Kaplan-Meier

```{r}
library(survminer)
library(ggplot2)
ggsurvplot(fits, 
           risk.table = TRUE,
           pval = TRUE,
           break.time.by = 360)
```

### Représentation par type de traitement

```{r}
fits_trt <- survfit(Surv(df$duree, df$arret_trt)~df$typetrt)
fits_trt
```

```{r}
summary(fits_trt)
```

```{r}
ggsurvplot(fits_trt, 
           risk.table = TRUE, 
           pval = TRUE,
           break.time.by = 360)
```

